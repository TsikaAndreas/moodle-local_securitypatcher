define(["jquery","core/ajax","core/notification","local_codepatcher/repository","core/str","core/modal_factory","local_codepatcher/jquery.dataTables","local_codepatcher/dataTables.dateTime","local_codepatcher/dataTables.bootstrap4","local_codepatcher/dataTables.buttons","local_codepatcher/buttons.bootstrap4","local_codepatcher/buttons.colVis","local_codepatcher/dataTables.responsive","local_codepatcher/responsive.bootstrap4"],function(l,e,r,n,s,o,t){function a(o){l(document).ready(function(){let c=l("#patchesreporttable").DataTable({dom:"Brtrip",responsive:{details:{type:"column",target:0}},columnDefs:[{responsivePriority:1,className:"control",orderable:false,targets:0,searchable:false},{responsivePriority:1,targets:1},{responsivePriority:2,searchable:false,targets:-1,orderable:false}],order:[[1,"desc"]],processing:true,serverSide:true,ajax:function(e,t,a){u(false);let r={id:o.id,data:JSON.stringify(e)};n.get_patch_reports(r).then(e=>{t({draw:e.draw,recordsTotal:e.recordsTotal,recordsFiltered:e.recordsFiltered,data:e.data})}).catch(e=>{u(false)})},columns:[{data:null,defaultContent:""},{data:"timecreated",name:"timecreated",type:"datetime"},{data:"status",name:"status",type:"select"},{data:"operation",name:"operation",type:"select"},{data:"actions"}],buttons:[{extend:"colvis",columns:"th:nth-child(n+2)"}],initComplete:function(e,t){u(false);d(this.api(),e.aoColumns,o.filters)}});c.columns().every(function(e){if(this.responsiveHidden()===false){l("#patchesreporttable thead tr:eq(1)").find("th:eq("+e+") ").hide()}});c.on("responsive-resize",function(e,t,a){a.forEach(function(e,t){if(e){l("#patchesreporttable thead tr:eq(1)").find("th:eq("+t+") ").show()}else{l("#patchesreporttable thead tr:eq(1)").find("th:eq("+t+") ").hide()}})});c.on("click","tbody tr button.view-report-action",function(){let e=parseInt(this.getAttribute("data-report"),10);u(true);let t={reportid:e};n.get_patch_report_info(t).then(function(t){if(Object.keys(t.result).length!==0){let e="<pre class='report-info-content'>"+t.result.content+"</pre>";h(t.result.date,e)}u(false)}).catch(function(){u(false)})});c.on("click","tbody tr button.delete-report-action",function(){let t=this;let a=parseInt(this.getAttribute("data-report"),10);let e=s.get_string("patchesreport:report_confirmdelete","local_codepatcher");let r=s.get_string("patchesreport:report_confirmdeletebtn","local_codepatcher");let o=function(){u(true);let e={reportid:a};n.delete_patch_report(e).then(function(e){if(e.result){c.row(t.closest("tr")).remove().draw()}u(false)}).catch(function(){u(false)})};i(e,r,o)})})}function i(e,t,a){r.confirm(s.get_string("confirm_title","local_codepatcher"),e,t,s.get_string("confirm_cancel","local_codepatcher"),a,null)}function d(c,e,n){l("#patchesreporttable thead tr").clone(false).appendTo("#patchesreporttable thead");e.forEach(function(e){let t=l("#patchesreporttable thead tr:eq(1) th:eq("+e.idx+")");let a=t.text();if(e.searchable===false){t.html("");return}let r=t.attr("class").split(" ");let o=r.filter(function(e){return e.includes("sorting")});t.removeClass(o.join(" "));p(c,e,t,a,n)})}function p(e,t,a,r,o){switch(true){case["text","datetime"].includes(t.type):a.html('<input class="form-control text-center w-100" type="text" placeholder="'+r+'"/>');l("input",a).on("keyup change",function(){if(e.column(t.idx).search()!==this.value){e.column(t.idx).search(this.value).draw()}});if(t.type==="datetime"){new DateTime(l("input",a),{format:"DD-MM-YYYY",buttons:{clear:true}})}break;case t.type==="select"&&o.hasOwnProperty(t.name):a.html(o[t.name]);l("select",a).on("change",function(){if(e.column(t.idx).search()!==this.value){e.column(t.idx).search(this.value).draw()}});break}}async function h(e,t){let a=await o.create({title:e,body:t,large:true,removeOnClose:true});u(false);a.show()}function u(e){let t=l("#patches-report-modal-wrapper .datatable-loader");if(e){t.show()}else{t.hide()}}const c=function(e){a(e)};return{init:c}});