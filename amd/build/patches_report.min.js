define(["jquery","core/ajax","core/notification","local_securitypatcher/repository","core/str","core/modal_factory","local_securitypatcher/jquery.dataTables","local_securitypatcher/dataTables.dateTime","local_securitypatcher/dataTables.bootstrap4","local_securitypatcher/dataTables.buttons","local_securitypatcher/buttons.bootstrap4","local_securitypatcher/buttons.colVis","local_securitypatcher/dataTables.responsive","local_securitypatcher/responsive.bootstrap4"],function($,Ajax,Notification,Repository,Str,ModalFactory,DataTable){function load_datatable(options){$(document).ready(function(){let table=$("#patchesreporttable").DataTable({dom:"Brtrip",responsive:{details:{type:"column",target:0}},columnDefs:[{responsivePriority:1,className:"control",orderable:false,targets:0,searchable:false},{responsivePriority:1,targets:1},{responsivePriority:2,searchable:false,targets:-1,orderable:false}],order:[[1,"desc"]],processing:true,serverSide:true,ajax:function(data,callback,settings){datatable_loader(false);let args={id:options.id,data:JSON.stringify(data)};Repository.get_patch_reports(args).then(res=>{callback({draw:res.draw,recordsTotal:res.recordsTotal,recordsFiltered:res.recordsFiltered,data:res.data})}).catch(error=>{datatable_loader(false)})},columns:[{data:null,defaultContent:""},{data:"timecreated",name:"timecreated",type:"datetime"},{data:"status",name:"status",type:"select"},{data:"operation",name:"operation",type:"select"},{data:"actions"}],buttons:[{extend:"colvis",columns:"th:nth-child(n+2)"}],initComplete:function(settings,json){datatable_loader(false);add_column_filters(this.api(),settings.aoColumns,options.filters)}});table.columns().every(function(index){if(this.responsiveHidden()===false){$("#patchesreporttable thead tr:eq(1)").find("th:eq("+index+") ").hide()}});table.on("responsive-resize",function(e,datatable,columns){columns.forEach(function(visible,index){if(visible){$("#patchesreporttable thead tr:eq(1)").find("th:eq("+index+") ").show()}else{$("#patchesreporttable thead tr:eq(1)").find("th:eq("+index+") ").hide()}})});table.on("click","tbody tr button.view-report-action",function(){let report=parseInt(this.getAttribute("data-report"),10);datatable_loader(true);let args={reportid:report};Repository.get_patch_report_info(args).then(function(res){if(Object.keys(res.result).length!==0){let content="<pre class='report-info-content'>"+res.result.content+"</pre>";display_report_content(res.result.date,content)}datatable_loader(false)}).catch(function(){datatable_loader(false)})});table.on("click","tbody tr button.delete-report-action",function(){let node=this;let report=parseInt(this.getAttribute("data-report"),10);let confirmQuestion=Str.get_string("patchesreport:report_confirmdelete","local_securitypatcher");let confirmButton=Str.get_string("patchesreport:report_confirmdeletebtn","local_securitypatcher");let confirmCallback=function(){datatable_loader(true);let args={reportid:report};Repository.delete_patch_report(args).then(function(res){if(res.result){table.row(node.closest("tr")).remove().draw()}datatable_loader(false)}).catch(function(){datatable_loader(false)})};show_confirmation(confirmQuestion,confirmButton,confirmCallback)})})}function show_confirmation(question,confirmButton,confirmCallback){Notification.confirm(Str.get_string("confirm_title","local_securitypatcher"),question,confirmButton,Str.get_string("confirm_cancel","local_securitypatcher"),confirmCallback,null)}function add_column_filters(table,columns,filterOptions){$("#patchesreporttable thead tr").clone(false).appendTo("#patchesreporttable thead");columns.forEach(function(item){let clonedCell=$("#patchesreporttable thead tr:eq(1) th:eq("+item.idx+")");let title=clonedCell.text();if(item.searchable===false){clonedCell.html("");return}let classesArray=clonedCell.attr("class").split(" ");let sortClasses=classesArray.filter(function(className){return className.includes("sorting")});clonedCell.removeClass(sortClasses.join(" "));create_filter_input(table,item,clonedCell,title,filterOptions)})}function create_filter_input(table,item,cell,title,filterOptions){switch(true){case["text","datetime"].includes(item.type):cell.html('<input class="form-control text-center w-100" type="text" placeholder="'+title+'"/>');$("input",cell).on("keyup change",function(){if(table.column(item.idx).search()!==this.value){table.column(item.idx).search(this.value).draw()}});if(item.type==="datetime"){new DateTime($("input",cell),{format:"DD-MM-YYYY",buttons:{clear:true}})}break;case item.type==="select"&&filterOptions.hasOwnProperty(item.name):cell.html(filterOptions[item.name]);$("select",cell).on("change",function(){if(table.column(item.idx).search()!==this.value){table.column(item.idx).search(this.value).draw()}});break}}async function display_report_content(title,content){let modal=await ModalFactory.create({title:title,body:content,large:true,removeOnClose:true});datatable_loader(false);modal.show()}function datatable_loader(enable){let loader=$("#patches-report-modal-wrapper .datatable-loader");if(enable){loader.show()}else{loader.hide()}}const init=function(options){load_datatable(options)};return{init:init}});