define(["jquery","core/ajax","core/notification","local_codepatcher/repository","core/prefetch","core/str","core/modal_factory","core/modal_events","core/templates","local_codepatcher/jquery.dataTables","local_codepatcher/dataTables.dateTime","local_codepatcher/dataTables.bootstrap4","local_codepatcher/dataTables.buttons","local_codepatcher/buttons.bootstrap4","local_codepatcher/buttons.colVis","local_codepatcher/buttons.html5","local_codepatcher/buttons.print","local_codepatcher/pdfmake","local_codepatcher/dataTables.responsive","local_codepatcher/responsive.bootstrap4"],function(l,t,r,s,e,i,c,a,p,o){function n(o){l(document).ready(function(){let n=l("#patchestable").DataTable({dom:"Brtrip",responsive:{details:{type:"column",target:0}},columnDefs:[{responsivePriority:1,className:"control",orderable:false,targets:0,searchable:false},{responsivePriority:1,targets:1},{responsivePriority:2,searchable:false,targets:-1,orderable:false}],order:[[3,"desc"]],processing:true,serverSide:true,ajax:function(t,e,a){y(false);let c={data:JSON.stringify(t)};s.get_patches(c).then(t=>{e({draw:t.draw,recordsTotal:t.recordsTotal,recordsFiltered:t.recordsFiltered,data:t.data})}).catch(t=>{y(false)})},columns:[{data:null,defaultContent:""},{data:"name",name:"name",type:"text"},{data:"lastaction",name:"status",type:"select"},{data:"created",name:"timecreated",type:"datetime"},{data:"modified",name:"timemodified",type:"datetime"},{data:"applied",name:"timeapplied",type:"datetime"},{data:"restored",name:"timerestored",type:"datetime"},{data:"actions"}],buttons:[{extend:"colvis",columns:"th:nth-child(n+2)"},{extend:"collection",className:"exportButton",text:"Export",buttons:[{extend:"copy",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"print",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"excel",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"pdf",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"csv",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}}]}],initComplete:function(t,e){y(false);let a=o["patches"]??{};d(this.api(),t.aoColumns,a)}});n.columns().every(function(t){if(this.responsiveHidden()===false){l("thead tr:eq(1)").find("th:eq("+t+") ").hide()}});n.on("responsive-resize",function(t,e,a){a.forEach(function(t,e){if(t){l("thead tr:eq(1)").find("th:eq("+e+") ").show()}else{l("thead tr:eq(1)").find("th:eq("+e+") ").hide()}})});n.on("click","tbody tr button.delete-patch-action",function(){let e=this;let a=parseInt(this.getAttribute("data-patch"),10);let t=i.get_string("patches:patch_confirmdelete","local_codepatcher");let c=i.get_string("patches:patch_confirmdeletebtn","local_codepatcher");let o=function(){y(true);let t={patchid:a};s.delete_patch(t).then(function(t){if(t.result){n.row(e.closest("tr")).remove().draw()}y(false)}).catch(function(){y(false)})};f(t,c,o)});n.on("click","tbody tr button.apply-patch-action",function(){let e=parseInt(this.getAttribute("data-patch"),10);let a=this;let t=i.get_string("patches:patch_confirmapply","local_codepatcher");let c=i.get_string("patches:patch_confirmapplybtn","local_codepatcher");let o=function(){y(true);let t={patchid:e};s.apply_patch(t).then(function(e){if(e.result){let t=n.row(a.closest("tr")).index();n.cell(t,5).data(e.result.timestamp);n.cell(t,2).data(e.result.status)}y(false)}).catch(function(){y(false)})};f(t,c,o)});n.on("click","tbody tr button.restore-patch-action",function(){let e=parseInt(this.getAttribute("data-patch"),10);let a=this;let t=i.get_string("patches:patch_confirmrestore","local_codepatcher");let c=i.get_string("patches:patch_confirmrestorebtn","local_codepatcher");let o=function(){y(true);let t={patchid:e};s.restore_patch(t).then(function(e){if(e.result){let t=n.row(a.closest("tr")).index();n.cell(t,6).data(e.result.timestamp);n.cell(t,2).data(e.result.status)}y(false)}).catch(function(){y(false)})};f(t,c,o)});n.on("click","tbody tr button.view-patch-action",function(){let t=parseInt(this.getAttribute("data-patch"),10);y(true);let e={patchid:t};s.get_patch_info(e).then(function(e){if(Object.keys(e.result).length!==0){let t="<pre class='patch-info-content'>"+e.result.content+"</pre>";m(e.result.name,t)}y(false)}).catch(function(){y(false)})});n.on("click","tbody tr button.report-patch-action",function(){let t=o["patchesreport"]??{};let c={patchid:parseInt(this.getAttribute("data-id"),10),patchname:this.getAttribute("data-name"),filters:JSON.stringify(t)};p.renderForPromise("local_codepatcher/patches_report",c).then(async({html:t,js:e})=>{let a=document.createElement("div");a.id="patches-report-modal-wrapper";await h(c.patchname,a);p.appendNodeContents(l("#patches-report-modal-wrapper"),t,e)}).catch(t=>r.exception(t))})})}async function h(t,e){let a=await c.create({title:i.get_string("datatable:patchesreport","local_codepatcher",t),body:e,large:true,removeOnClose:true});y(false);a.show()}function d(n,t,r){l("#patchestable thead tr").clone(false).appendTo("#patchestable thead");t.forEach(function(t){let e=l("#patchestable thead tr:eq(1) th:eq("+t.idx+")");let a=e.text();if(t.searchable===false){e.html("");return}let c=e.attr("class").split(" ");let o=c.filter(function(t){return t.includes("sorting")});e.removeClass(o.join(" "));u(n,t,e,a,r)})}function u(t,e,a,c,o){switch(true){case["text","datetime"].includes(e.type):a.html('<input class="form-control text-center w-100" type="text" placeholder="'+c+'"/>');l("input",a).on("keyup change",function(){if(t.column(e.idx).search()!==this.value){t.column(e.idx).search(this.value).draw()}});if(e.type==="datetime"){new DateTime(l("input",a),{format:"DD-MM-YYYY",buttons:{clear:true}})}break;case e.type==="select"&&o.hasOwnProperty(e.name):a.html(o[e.name]);l("select",a).on("change",function(){if(t.column(e.idx).search()!==this.value){t.column(e.idx).search(this.value).draw()}});break}}function f(t,e,a){r.confirm(i.get_string("confirm_title","local_codepatcher"),t,e,i.get_string("confirm_cancel","local_codepatcher"),a,null)}async function m(t,e){let a=await c.create({title:t,body:e,large:true,removeOnClose:true});y(false);a.show()}function _(){e.prefetchStrings("local_codepatcher",["confirm_title","confirm_cancel","patches:patch_confirmdelete","patches:patch_confirmdeletebtn","patches:patch_confirmapply","patches:patch_confirmapplybtn","patches:patch_confirmrestore","patches:patch_confirmrestorebtn","datatable:patchesreport","patchesreport:report_confirmdeletebtn","patchesreport:report_confirmdelete"])}function b(){e.prefetchTemplate("local_codepatcher/patches_report")}function y(t){let e=l(".table-wrapper .datatable-loader");if(t){e.show()}else{e.hide()}}const g=function(t){_();b();n(t)};return{init:g}});