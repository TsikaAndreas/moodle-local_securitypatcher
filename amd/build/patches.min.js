define(["jquery","core/ajax","core/notification","local_securitypatcher/repository","core/prefetch","core/str","core/modal_factory","core/modal_events","core/templates","local_securitypatcher/jquery.dataTables","local_securitypatcher/dataTables.dateTime","local_securitypatcher/dataTables.bootstrap4","local_securitypatcher/dataTables.buttons","local_securitypatcher/buttons.bootstrap4","local_securitypatcher/buttons.colVis","local_securitypatcher/buttons.html5","local_securitypatcher/buttons.print","local_securitypatcher/pdfmake","local_securitypatcher/dataTables.responsive","local_securitypatcher/responsive.bootstrap4"],function($,Ajax,Notification,Repository,Prefetch,Str,ModalFactory,ModalEvents,Template,DataTable){function load_datatable(filterOptions){$(document).ready(function(){let table=$("#patchestable").DataTable({dom:"Brtrip",responsive:{details:{type:"column",target:0}},columnDefs:[{responsivePriority:1,className:"control",orderable:false,targets:0,searchable:false},{responsivePriority:1,targets:1},{responsivePriority:2,searchable:false,targets:-1,orderable:false}],order:[[3,"desc"]],processing:true,serverSide:true,ajax:function(data,callback,settings){datatable_loader(false);let args={data:JSON.stringify(data)};Repository.get_patches(args).then(res=>{callback({draw:res.draw,recordsTotal:res.recordsTotal,recordsFiltered:res.recordsFiltered,data:res.data})}).catch(error=>{datatable_loader(false)})},columns:[{data:null,defaultContent:""},{data:"name",name:"name",type:"text"},{data:"lastaction",name:"status",type:"select"},{data:"created",name:"timecreated",type:"datetime"},{data:"modified",name:"timemodified",type:"datetime"},{data:"applied",name:"timeapplied",type:"datetime"},{data:"restored",name:"timerestored",type:"datetime"},{data:"actions"}],buttons:[{extend:"colvis",columns:"th:nth-child(n+2)"},{extend:"collection",className:"exportButton",text:"Export",buttons:[{extend:"copy",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"print",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"excel",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"pdf",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}},{extend:"csv",exportOptions:{columns:"th:not(:last-child):nth-child(n+2)"}}]}],initComplete:function(settings,json){datatable_loader(false);add_column_filters(this.api(),settings.aoColumns,filterOptions)},drawCallback:function(){}});table.columns().every(function(index){if(this.responsiveHidden()===false){$("thead tr:eq(1)").find("th:eq("+index+") ").hide()}});table.on("responsive-resize",function(e,datatable,columns){columns.forEach(function(visible,index){if(visible){$("thead tr:eq(1)").find("th:eq("+index+") ").show()}else{$("thead tr:eq(1)").find("th:eq("+index+") ").hide()}})});table.on("click","tbody tr button.delete-patch-action",function(){let node=this;let patch=parseInt(this.getAttribute("data-patch"),10);let confirmQuestion=Str.get_string("patches:patch_confirmdelete","local_securitypatcher");let confirmButton=Str.get_string("patches:patch_confirmdeletebtn","local_securitypatcher");let confirmCallback=function(){datatable_loader(true);let args={patchid:patch};Repository.delete_patch(args).then(function(res){if(res.result){table.row(node.closest("tr")).remove().draw()}datatable_loader(false)}).catch(function(){datatable_loader(false)})};show_confirmation(confirmQuestion,confirmButton,confirmCallback)});table.on("click","tbody tr button.apply-patch-action",function(){let patch=parseInt(this.getAttribute("data-patch"),10);let node=this;let confirmQuestion=Str.get_string("patches:patch_confirmapply","local_securitypatcher");let confirmButton=Str.get_string("patches:patch_confirmapplybtn","local_securitypatcher");let confirmCallback=function(){datatable_loader(true);let args={patchid:patch};Repository.apply_patch(args).then(function(res){if(res.result){let row=table.row(node.closest("tr")).index();table.cell(row,5).data(res.result.timestamp);table.cell(row,2).data(res.result.status)}datatable_loader(false)}).catch(function(){datatable_loader(false)})};show_confirmation(confirmQuestion,confirmButton,confirmCallback)});table.on("click","tbody tr button.restore-patch-action",function(){let patch=parseInt(this.getAttribute("data-patch"),10);let node=this;let confirmQuestion=Str.get_string("patches:patch_confirmrestore","local_securitypatcher");let confirmButton=Str.get_string("patches:patch_confirmrestorebtn","local_securitypatcher");let confirmCallback=function(){datatable_loader(true);let args={patchid:patch};Repository.restore_patch(args).then(function(res){if(res.result){let row=table.row(node.closest("tr")).index();table.cell(row,6).data(res.result.timestamp);table.cell(row,2).data(res.result.status)}datatable_loader(false)}).catch(function(){datatable_loader(false)})};show_confirmation(confirmQuestion,confirmButton,confirmCallback)});table.on("click","tbody tr button.view-patch-action",function(){let patch=parseInt(this.getAttribute("data-patch"),10);datatable_loader(true);let args={patchid:patch};Repository.get_patch_info(args).then(function(res){if(Object.keys(res.result).length!==0){let content="<pre class='patch-info-content'>"+res.result.content+"</pre>";display_patch_content(res.result.name,content)}datatable_loader(false)}).catch(function(){datatable_loader(false)})});table.on("click","tbody tr button.report-patch-action",function(){let patch=parseInt(this.getAttribute("data-patch"),10);datatable_loader(true);let args={patchid:patch};Repository.get_patch_reports(args).then(function(res){console.log(res);if(Object.keys(res.result).length!==0){let context={data:res.result};Template.renderForPromise("local_securitypatcher/patches_report",context).then(async({html,js})=>{let output=document.createElement("div");Template.appendNodeContents(output,html,js);let modal=await ModalFactory.create({title:Str.get_string("datatable:patchesreport","local_securitypatcher",patch),body:output,large:true,removeOnClose:true});datatable_loader(false);modal.show();modal.getRoot().on(ModalEvents.destroyed,function(){console.log("modal destroyed")})}).catch(error=>Notification.exception(error))}datatable_loader(false)}).catch(function(){datatable_loader(false)})})})}function add_column_filters(table,columns,filterOptions){$("#patchestable thead tr").clone(false).appendTo("#patchestable thead");columns.forEach(function(item){let clonedCell=$("#patchestable thead tr:eq(1) th:eq("+item.idx+")");let title=clonedCell.text();if(item.searchable===false){clonedCell.html("");return}let classesArray=clonedCell.attr("class").split(" ");let sortClasses=classesArray.filter(function(className){return className.includes("sorting")});clonedCell.removeClass(sortClasses.join(" "));create_filter_input(table,item,clonedCell,title,filterOptions)})}function create_filter_input(table,item,cell,title,filterOptions){switch(true){case["text","datetime"].includes(item.type):cell.html('<input class="form-control text-center w-100" type="text" placeholder="'+title+'"/>');$("input",cell).on("keyup change",function(){if(table.column(item.idx).search()!==this.value){table.column(item.idx).search(this.value).draw()}});if(item.type==="datetime"){new DateTime($("input",cell),{format:"DD-MM-YYYY"})}break;case item.type==="select"&&item.name==="status"&&filterOptions.hasOwnProperty(item.name):cell.html(filterOptions[item.name]);$("select",cell).on("change",function(){if(table.column(item.idx).search()!==this.value){table.column(item.idx).search(this.value).draw()}});break}}function show_confirmation(question,confirmButton,confirmCallback){Notification.confirm(Str.get_string("confirm_title","local_securitypatcher"),question,confirmButton,Str.get_string("confirm_cancel","local_securitypatcher"),confirmCallback,null)}async function display_patch_content(title,content){let modal=await ModalFactory.create({title:title,body:content,large:true,removeOnClose:true});datatable_loader(false);modal.show()}function prefetch_strings(){Prefetch.prefetchStrings("local_securitypatcher",["confirm_title","confirm_cancel","patches:patch_confirmdelete","patches:patch_confirmdeletebtn","patches:patch_confirmapply","patches:patch_confirmapplybtn","patches:patch_confirmrestore","patches:patch_confirmrestorebtn"])}function prefetch_templates(){Prefetch.prefetchTemplate("local_securitypatcher/patches_report")}function datatable_loader(enable){let loader=$(".table-wrapper .datatable-loader");if(enable){loader.show()}else{loader.hide()}}const init=function(filterOptions){prefetch_strings();prefetch_templates();load_datatable(filterOptions)};return{init:init}});